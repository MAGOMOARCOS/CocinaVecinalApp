name: Agent Auto-Fix (Build -> Patch -> PR)

on:
  workflow_dispatch: {}
  push:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-autofix-${{ github.ref }}
  cancel-in-progress: true

jobs:
  autofix:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (if package-lock exists)
        shell: bash
        run: |
          set -e
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build (capture logs)
        id: build
        shell: bash
        run: |
          set +e
          npm run build 2>&1 | tee build.log
          echo "code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Stop if build is green
        if: ${{ steps.build.outputs.code == '0' }}
        run: |
          echo "Build OK. Nothing to fix."

      - name: Create branch for fix
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          BR="agent/fix-build-${{ github.run_id }}"
          echo "BRANCH=$BR" >> $GITHUB_ENV
          git checkout -b "$BR"

      - name: Snapshot repo (paths)
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          echo "=== ROOT LS ===" > snapshot.txt
          ls -la >> snapshot.txt
          echo "" >> snapshot.txt
          echo "=== TOP FILES (depth 4) ===" >> snapshot.txt
          find . -maxdepth 4 -type f \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -print | sort >> snapshot.txt

      - name: Ask OpenAI for a unified diff patch
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "Missing OPENAI_API_KEY secret"
            exit 1
          fi

          # Build prompt
          cat > prompt.txt << 'PROMPT'
You are an expert Next.js + TypeScript build-fixer.
Goal: produce a single unified diff patch that makes `npm run build` pass on Vercel.
Constraints:
- Keep changes minimal.
- Do not add new unrelated features.
- Do not remove core app files.
- If folders are misplaced (e.g., app/ inside .github/), move them to correct locations.
- Ensure Next.js detects App Router (app/ with page.tsx and layout.tsx).
Output format:
- ONLY output a unified diff patch (git apply compatible), starting with "diff --git".
PROMPT

          echo "" >> prompt.txt
          echo "=== BUILD LOG ===" >> prompt.txt
          tail -n 400 build.log >> prompt.txt
          echo "" >> prompt.txt
          echo "=== SNAPSHOT ===" >> prompt.txt
          head -n 600 snapshot.txt >> prompt.txt

          # Call Responses API (recommended)
          # https://api.openai.com/v1/responses
          curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- <<JSON > resp.json
{
  "model": "gpt-5.2",
  "input": [
    {
      "role": "user",
      "content": [
        { "type": "input_text", "text": "$(python3 - <<'PY'\nimport json\nprint(open('prompt.txt','r',encoding='utf-8').read().replace('\\\\','\\\\\\\\').replace('\"','\\\\\"').replace('\\n','\\\\n'))\nPY)" }
      ]
    }
  ],
  "max_output_tokens": 2200
}
JSON

          # Extract text from response (best-effort)
          python3 - <<'PY'
import json,sys
data=json.load(open("resp.json","r",encoding="utf-8"))
# Try common locations
out=""
if isinstance(data, dict):
  if "output_text" in data and isinstance(data["output_text"], str):
    out=data["output_text"]
  elif "output" in data and isinstance(data["output"], list):
    # concat text blocks if present
    parts=[]
    for item in data["output"]:
      if isinstance(item, dict):
        content=item.get("content")
        if isinstance(content, list):
          for c in content:
            if isinstance(c, dict) and c.get("type") in ("output_text","text"):
              parts.append(c.get("text",""))
    out="".join(parts)
open("patch.diff","w",encoding="utf-8").write(out.strip()+"\n")
print("Patch chars:", len(out))
PY

          # sanity check
          if ! grep -q "^diff --git" patch.diff; then
            echo "Model did not return a unified diff. Showing first 80 lines:"
            head -n 80 patch.diff || true
            exit 1
          fi

      - name: Apply patch
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          git apply --whitespace=fix patch.diff
          git status --porcelain

      - name: Re-run build after patch
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          npm run build

      - name: Commit changes
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          git config user.name "cocinavecinal-agent"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          git commit -m "chore(agent): auto-fix build"

      - name: Push branch
        if: ${{ steps.build.outputs.code != '0' }}
        shell: bash
        run: |
          set -e
          git push -u origin "$BRANCH"

      - name: Open PR
        if: ${{ steps.build.outputs.code != '0' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e
          gh pr create \
            --title "Agent: fix build" \
            --body "Automated build fix generated by agent. Please review." \
            --base main \
            --head "$BRANCH"
