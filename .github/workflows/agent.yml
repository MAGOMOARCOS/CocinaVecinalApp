name: Agent Orchestrator

on:
  workflow_dispatch:
    inputs:
      run_agent:
        description: "Run agent job after preflight"
        required: true
        default: "true"
      force_agent:
        description: "Run agent even if preflight fails"
        required: true
        default: "false"

concurrency:
  group: agent-orchestrator-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.pf.outputs.ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Preflight (FREE): install + build
        id: pf
        shell: bash
        run: |
          set -euo pipefail
          echo "Node: $(node -v)"
          echo "npm:  $(npm -v)"

          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

          npm run build
          echo "ok=true" >> "$GITHUB_OUTPUT"

  agent:
    runs-on: ubuntu-latest
    needs: preflight

    # Corre si:
    # - run_agent == "true" y preflight ok
    # - o force_agent == "true" (aunque preflight falle)
    if: >
      (github.event_name == 'workflow_dispatch' && inputs.force_agent == 'true')
      || (github.event_name == 'workflow_dispatch' && inputs.run_agent == 'true' && needs.preflight.outputs.ok == 'true')

    steps:
      - name: Checkout (with credentials)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git identity
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "MAGOMOARCOS"
          git config user.email "92266733+MAGOMOARCOS@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Agent Controller (creates branch + PR from AGENT_TASKS.md)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          python3 --version

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "Missing OPENAI_API_KEY secret. Add it in: Settings -> Secrets and variables -> Actions."
            exit 1
          fi

          python3 scripts/agent_controller.py
