name: Agent (PR-driven)

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Instrucción extra (opcional)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run agent (write files, build, PR)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INSTRUCTION: ${{ inputs.instruction }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          BRANCH="agent/run-${GITHUB_RUN_ID}"
          git checkout -b "$BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          python3 - <<'PY'
          import os, json, sys, urllib.request, urllib.error, subprocess, pathlib

          api_key = os.environ["OPENAI_API_KEY"]
          instruction = os.environ.get("INSTRUCTION", "")

          # Leer archivos reales que pueden tocarse
          TARGET_FILES = ["app/layout.tsx"]

          files_content = {}
          for path in TARGET_FILES:
              try:
                  with open(path, "r", encoding="utf-8") as f:
                      files_content[path] = f.read()
              except FileNotFoundError:
                  files_content[path] = ""

          system = (
              "Eres un agente de ingeniería de software.\n"
              "Devuelve EXCLUSIVAMENTE un JSON con este formato:\n"
              "{\n"
              '  "files": {\n'
              '    "path/archivo.tsx": "CONTENIDO COMPLETO DEL ARCHIVO"\n'
              "  }\n"
              "}\n\n"
              "Reglas:\n"
              "- Devuelve el ARCHIVO COMPLETO, no diff.\n"
              "- No modifiques .github/workflows.\n"
              "- Cambios mínimos.\n"
              "- El código debe compilar en Next.js App Router.\n"
          )

          user = {
              "instruction": instruction,
              "files": files_content
          }

          payload = {
              "model": "gpt-4o-mini",
              "input": [
                  {"role": "system", "content": [{"type": "input_text", "text": system}]},
                  {"role": "user", "content": [{"type": "input_text", "text": json.dumps(user)}]},
              ],
          }

          req = urllib.request.Request(
              "https://api.openai.com/v1/responses",
              data=json.dumps(payload).encode(),
              headers={
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json",
              },
          )

          with urllib.request.urlopen(req) as r:
              data = json.loads(r.read().decode())

          text = ""
          for item in data.get("output", []):
              if item.get("type") == "message":
                  for c in item.get("content", []):
                      if c.get("type") == "output_text":
                          text += c.get("text", "")

          result = json.loads(text)

          for path, content in result.get("files", {}).items():
              pathlib.Path(path).parent.mkdir(parents=True, exist_ok=True)
              with open(path, "w", encoding="utf-8") as f:
                  f.write(content)

          PY

          npm run build

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "agent: apply tasks"
            git push -u origin "$BRANCH"

            gh pr create \
              --title "Agent: apply AGENT_TASKS.md" \
              --body "PR generado automáticamente por el agente." \
              --base main \
              --head "$BRANCH"
          else
            echo "No changes"
          fi
