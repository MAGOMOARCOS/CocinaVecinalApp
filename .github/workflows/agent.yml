name: Agent Orchestrator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "preflight = solo build (gratis). full = build + ejecutar agente (requiere OPENAI_API_KEY)."
        required: true
        default: "preflight"
        type: choice
        options:
          - preflight
          - full
  push:
    paths:
      - "AGENT_TASKS.md"

concurrency:
  group: agent-orchestrator-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.pf.outputs.ok }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

       name: Preflight (FREE): install + build
        id: pf
        shell: bash
        run: |
          set -euo pipefail
          echo "Node: $(node -v)"
          echo "npm:  $(npm -v)"

          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

          npm run build
          echo "ok=true" >> "$GITHUB_OUTPUT"

  agent:
    needs: preflight
    if: ${{ needs.preflight.outputs.ok == 'true' && github.event_name == 'workflow_dispatch' && inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with credentials)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git auth (avoid terminal prompts)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          git config user.name "MAGOMOARCOS"
          git config user.email "92266733+MAGOMOARCOS@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git fetch --prune --tags

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Agent Controller (creates branch + PR from AGENT_TASKS.md)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          python3 --version

          test -n "${OPENAI_API_KEY:-}" || (echo "Missing OPENAI_API_KEY secret. Add it in Settings → Secrets and variables → Actions." && exit 1)

          python3 scripts/agent_controller.py
