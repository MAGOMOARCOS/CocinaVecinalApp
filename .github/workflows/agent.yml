name: Repo Agent (Codex) - Fix Build + PR

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Instrucción directa para el agente (si se deja vacío, usa AGENT_TASKS.md)"
        required: false
        type: string

  push:
    paths:
      - "AGENT_TASKS.md"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: repo-agent-${{ github.workflow }}-${{ github.run_id }}
  cancel-in-progress: false


jobs:
  agent:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout con PAT
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      # ---------------------------
      # Node.js
      # ---------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ---------------------------
      # Instalar dependencias
      # ---------------------------
      - name: Install dependencies
        run: |
          set -e
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

      # ---------------------------
      # Crear rama del agente
      # ---------------------------
      - name: Create agent branch
        run: |
          set -e
          BRANCH="agent/codex-${GITHUB_RUN_ID}"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -b "$BRANCH"

      # ---------------------------
      # Preparar instrucción
      # ---------------------------
      - name: Prepare agent instruction
        run: |
          set -e
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.instruction }}" ]; then
            echo "${{ inputs.instruction }}" > /tmp/AGENT_INSTRUCTION.txt
          else
            if [ ! -f AGENT_TASKS.md ]; then
              echo "ERROR: No existe AGENT_TASKS.md ni se pasó instrucción manual."
              exit 1
            fi
            cp AGENT_TASKS.md /tmp/AGENT_INSTRUCTION.txt
          fi

      # ---------------------------
      # EJECUTAR CODEX (CORRECTO)
      # ---------------------------
      - name: Run Codex Repo Agent
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: /tmp/AGENT_INSTRUCTION.txt
          codex-home: ${{ github.workspace }}/.codex
          sandbox: workspace-write
          safety-strategy: drop-sudo

      # ---------------------------
      # Verificar conflictos Git
      # ---------------------------
      - name: Fail if conflict markers exist
        run: |
          set -e
          if grep -RIn --exclude-dir=node_modules --exclude-dir=.git -E '^(<<<<<<<|=======|>>>>>>>)' .; then
            echo "ERROR: Conflict markers detectados."
            exit 1
          fi

      # ---------------------------
      # Build obligatorio
      # ---------------------------
      - name: npm run build
        run: |
          set -e
          npm run build

      # ---------------------------
      # Commit
      # ---------------------------
      - name: Commit changes
        run: |
          set -e
          git config user.name "repo-agent"
          git config user.email "repo-agent@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No hay cambios que commitear."
            exit 0
          fi
          git commit -m "Agent: fix build (handleSubmit)"

      # ---------------------------
      # Push
      # ---------------------------
      - name: Push branch
        run: |
          git push -u origin "$BRANCH"

      # ---------------------------
      # Crear PR
      # ---------------------------
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh pr create \
            --title "Agent: fix build + handleSubmit" \
            --body "PR automática del Repo-Agent (Codex). Build verificado y sin conflictos." \
            --base main \
            --head "$BRANCH" || true
